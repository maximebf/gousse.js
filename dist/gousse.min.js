(function(root,factory){if(typeof define==="function"&&define.amd){define([],()=>{return root.gousse=factory()})}else if(typeof exports==="object"&&typeof exports.nodeName!=="string"){module.exports=factory()}else{root.gousse=factory();if(typeof window!=="undefined"){document.head.querySelectorAll("script").forEach(node=>{if(node.getAttribute("src").match(/gousse(-all)?(\.min)?\.js\?/)){let qs=node.getAttribute("src").split("?")[1].split("&");if(qs.indexOf("globals")!==-1){gousse.importGlobals()}if(qs.indexOf("shadow=replace")!==-1){gousse.component.customElementsShadowMode="replace"}if(qs.indexOf("shadow=false")!==-1){gousse.component.customElementsShadowMode=false}if(qs.indexOf("shadow=true")!==-1||qs.indexOf("shadow")!==-1){gousse.component.customElementsShadowMode=true}}})}}})(typeof self!=="undefined"?self:this,()=>{function ensureArray(items){if(items instanceof NodeList){return Array.prototype.slice.call(items,0)}return!items?[]:!Array.isArray(items)?[items]:items}function on(node,eventName,listener,onceOnly){if(typeof eventName==="function"){[onceOnly,listener,eventName,node]=[listener,eventName,node,document.body]}else if(node instanceof DocumentFragment){node.childNodes.forEach(child=>on(child,eventName,listener,onceOnly));return}else if(!(node instanceof Node)){if(!node){node=document.body}else if(typeof node==="string"){node=document.querySelector(node)}else{Object.entries(node).forEach(([key,value])=>on(key,value));return}}let off;const wrappedListener=e=>{listener(e);if(onceOnly){off()}};off=(()=>ensureArray(eventName).forEach(e=>node.removeEventListener(e,wrappedListener)));ensureArray(eventName).forEach(e=>node.addEventListener(e,wrappedListener));return off}function dispatch(eventName,data,node){let e=new CustomEvent(eventName,{detail:data,bubbles:true});(node||document.body).dispatchEvent(e)}function emitter(node,name,eventNames){ensureArray(eventNames||["change","keyup"]).forEach(event=>{on(node,event,e=>dispatch("ValueEmitted",{name:name,value:e.target.value},node))});return node}emitter.context=function(vars,nodes){return ensureArray(nodes).map(node=>{on(node,"ValueEmitted",e=>{e.stopPropagation();vars[e.detail.name]=e.detail.value});return node})};const attributeAnnotations={transform:(node,rootNode,evalThisArg)=>{Object.entries(attributeAnnotations).forEach(([name,callback])=>{if(name==="transform")return;node.querySelectorAll(`[data-${name}]`).forEach(node=>{callback(node,node.getAttribute(`data-${name}`),rootNode,evalThisArg)})})},dispatch:(node,value,rootNode,evalThisArg)=>{on(node,node.getAttribute("data-dispatch-event")||"click",()=>{let data=null;if(node.hasAttribute("data-dispatch-value")){data=function(){return eval("`"+node.getAttribute("data-dispatch-value")+"`")}.bind(evalThisArg||null)()}dispatch(value,data,rootNode)})},emit:(node,value)=>{emitter(node,value)},connect:(node,value,rootNode,evalThisArg)=>{let visibility=node.getAttribute("data-visibility")||"show";if(visibility!=="hide"){node.classList.add("gousse-hide")}on(value,e=>{if(node.hasAttribute("data-content")){node.innerText=function(event){return eval("`"+node.getAttribute("data-content")+"`")}.bind(evalThisArg||null)(e)}if(visibility==="hide"){node.classList.add("gousse-hide")}else if(visibility==="toggle"){node.classList.toggle("gousse-hide")}else{node.classList.remove("gousse-hide")}},!node.hasAttribute("data-content")&&!visibility)},emitted:(node,value,rootNode,evalThisArg)=>{on(rootNode,"ValueEmitted",e=>{if(e.detail.name===value){if(node.hasAttribute("data-content")){node.innerText=function(value){return eval("`"+node.getAttribute("data-content")+"`")}.bind(evalThisArg||null)(e.detail.value)}else{node.innerText=e.detail.value}}})}};const dom={query:(...args)=>document.querySelector(...args),queryAll:(...args)=>document.querySelectorAll(...args),setAttributes(node,attrs){Object.entries(attrs).forEach(([name,value])=>{if(name in attributeAnnotations){attributeAnnotations[name](node,value)}else if(name.match(/^data-/)&&name.substr(5)in attributeAnnotations){attributeAnnotations[name.substr(5)](node,value)}else if(name==="innerHTML"){Promise.resolve(value).then(html=>{node.innerHTML=html})}else if(name.match(/^on/)&&typeof value==="function"){node.addEventListener(name.substring(2),value)}else if(value!==null&&value!==undefined){node.setAttribute(name,value)}})},create(tagName,attrs,...children){let node=tagName;if(typeof tagName==="string"){node=document.createElement(tagName)}else{node.innerHTML=""}if(attrs){dom.setAttributes(node,attrs)}if(node.tagName==="A"&&!node.hasAttribute("href")){node.setAttribute("href","javascript:")}dom.append(node,children);return node},append(parent,nodes,insertBefore){if(!(parent instanceof Node)){parent=document.querySelector(parent)}let out=[];for(let node of ensureArray(nodes)){if(Array.isArray(node)){out=out.concat(dom.append(parent,node,insertBefore))}else if(node instanceof Promise){let placeholder=document.createComment("placeholder");out=out.concat(dom.append(parent,placeholder,insertBefore));node.then(nodes=>{dom.append(parent,nodes,placeholder);parent.removeChild(placeholder)})}else if(node){if(!(node instanceof Node)&&!(node instanceof DocumentFragment)){node=document.createTextNode(node)}if(insertBefore){parent.insertBefore(node,insertBefore)}else{parent.appendChild(node)}out.push(node)}}return out},remove:nodes=>ensureArray(nodes).map(node=>node.parentNode.removeChild(node)),replace:(newNode,oldNode)=>oldNode.parentNode.replaceChild(newNode,oldNode),content(node,...children){node.innerHTML="";return dom.append(node,children)}};const h=dom.create;function connect(eventName,listener,placeholder,onceOnly){const container=h("div",{class:"gousse-connect"});const render=e=>{let result=listener(e,render);if(result){dom.content(container,result)}else if(result===false){container.innerHTML=""}};if(eventName instanceof Promise){eventName.then(render)}else if(Array.isArray(eventName)||typeof eventName==="string"){on(eventName,render,onceOnly)}else{[onceOnly,placeholder,listener]=[false,listener,null];Object.entries(eventName).forEach(([key,value])=>on(key,e=>dom.content(container,value(e))))}if(placeholder===true&&listener){render()}else if(placeholder!==true){dom.append(container,placeholder)}return container}async function template(tpl,vars,...children){if(typeof tpl==="string"){tpl=await ready(()=>document.getElementById(tpl))}else{tpl=await Promise.resolve(tpl)}const root=document.importNode(tpl.content,true);root.querySelectorAll("[data-var]").forEach(node=>{let value=vars[node.getAttribute("data-var")];if(typeof value==="undefined"){return}if(node.hasAttribute("data-content")){node.innerText=(value=>eval("`"+node.getAttribute("data-content")+"`"))(value)}else{node.innerText=value}});root.querySelectorAll("[data-attr-vars]").forEach(node=>{node.getAttribute("data-attr-vars").split(",").forEach(part=>{let[varName,name]=part.indexOf(":")!==-1?part.split(":"):[part,part];if(typeof vars[varName]!=="undefined"&&vars[varName]!=="false"){node.setAttribute(name,vars[varName])}})});if(children.length){const slot=root.querySelector("slot");if(slot){dom.append(slot.parentNode,children,slot);dom.remove(slot)}}Object.entries(vars||{}).forEach(([key,value])=>{if(key.match(/^on/)){let event=key.substr(2);let nodes=root.childNodes;if(event.indexOf(":")!=="-1"){nodes=root.querySelectorAll(event.substr(event.indexOf(":")+1));event=event.substr(0,event.indexOf(":"))}nodes.forEach(node=>node.addEventListener(event,value))}});return root}class ComponentContext{constructor(renderCallback,eventDispatcher,rootNode){this.renderCallback=renderCallback;this.eventDispatcher=eventDispatcher;this.rootNode=rootNode;this.isConnected=false;this.connectCallbacks=[];this.disconnectCallbacks=[]}onconnect(listener){if(this.isConnected){listener()}else{this.connectCallbacks.push(listener)}}connected(){this.isConnected=true;this.connectCallbacks.forEach(fn=>requestAnimationFrame(fn))}ondisconnect(listener){this.disconnectCallbacks.push(listener)}disconnected(){this.disconnectCallbacks.forEach(fn=>fn())}on(eventName,listener,onceOnly){this.onconnect(()=>this.ondisconnect(on(eventName,listener,onceOnly)))}dispatch(originalEvent,name,data){if(typeof originalEvent==="string"){[data,name]=[name,originalEvent]}else if(originalEvent){originalEvent.stopPropagation()}dispatch(name,data,this.eventDispatcher||this.node)}emit(name,value){dispatch("ValueEmitted",{name:name,value:value},this.eventDispatcher||this.node)}waitOnRenderCallbackResult(result){if(result instanceof Promise){return result.then(result=>this.waitOnRenderCallbackResult(result))}if(Array.isArray(result)&&result.some(value=>value instanceof Promise)){return Promise.all(result)}return ensureArray(result)}processRenderNodes(nodes,afterRenderCallback){this.nodes=nodes;this.node=this.rootNode||nodes[nodes.length-1];emitter.context(this,nodes);nodes.forEach(node=>attributeAnnotations.transform(node,this.eventDispatcher,this));afterRenderCallback&&afterRenderCallback(nodes);return this.nodes}render(attrs,children,afterRenderCallback){let result=this.waitOnRenderCallbackResult(this.renderCallback.call(this,attrs,children,this));if(result instanceof Promise){return result.then(nodes=>this.processRenderNodes(nodes,afterRenderCallback))}return this.processRenderNodes(result,afterRenderCallback)}querySelector(...args){return this.node.querySelector(...args)}querySelectorAll(...args){return this.node.querySelectorAll(...args)}}class ComponentElement extends HTMLElement{constructor(renderCallback,shadowMode){super();this.shadowMode=shadowMode===undefined?false:shadowMode;this.rootNode=this.shadowMode===true?this.attachShadow({mode:"open"}):this;this.context=new ComponentContext(renderCallback,this,this.shadowMode!=="replace"?this.rootNode:null);this.virtualSlot=document.createComment("slot");this.hasBeenReplaced=false}render(){let attrs={};for(let name of this.getAttributeNames()){attrs[name]=this.getAttribute(name)}let children=Array.prototype.slice.call(this.childNodes,0);if(this.shadowMode!==true){children.push(this.virtualSlot)}return Promise.resolve(this.context.render(attrs,children)).then(()=>{if(this.shadowMode==="replace"){dom.replace(this.context.node,this.rootNode);this.rootNode=this.context.node;this.hasBeenReplaced=true}else{dom.content(this.rootNode,this.context.nodes)}})}connectedCallback(){this.render().then(()=>{if(this.shadowMode!==true){this.observer=new MutationObserver(mutations=>{if(this.virtualSlot.parentNode===null)return;mutations.forEach(mutation=>{for(let node of mutation.addedNodes){if(node.parentNode===this){this.virtualSlot.parentNode.insertBefore(node,this.virtualSlot)}}})});this.observer.observe(this,{childList:true})}this.context.connected()})}disconnectedCallback(){if(typeof this.observer!=="undefined"){this.observer.disconnect()}this.context.disconnected()}addEventListener(...args){if(this.shadowMode==="replace"){if(this.hasBeenReplaced){this.rootNode.addEventListener(...args)}else{this.context.onconnect(()=>this.rootNode.addEventListener(...args))}}else{super.addEventListener(...args)}}}function defineComponentElement(name,renderCallback,shadowMode){if(!component.customElementsAvailable){console.error("Custom elements are not supported in this browser");return}window.customElements.define(name,class extends ComponentElement{constructor(){super(renderCallback,shadowMode)}})}function component(name,renderCallback,shadow){if(typeof name==="function"){[renderCallback,name]=[name,null]}if(name&&component.customElementsAvailable){shadow=shadow!==undefined?shadow:component.customElementsShadowMode;defineComponentElement(name,renderCallback,shadow);if(shadow!=="replace"){return(attrs,...children)=>h(name,attrs,...children)}}else if(name){console.error("component(): Custom elements are not available, all components fallback to JS definition only")}return function(attrs,...children){const ctx=new ComponentContext(renderCallback);return ctx.render(attrs||{},children,()=>{ctx.node.addEventListener("DOMNodeInsertedIntoDocument",()=>ctx.connected());ctx.node.addEventListener("DOMNodeRemovedFromDocument",()=>ctx.disconnected())})}}component.customElementsAvailable="customElements"in window;component.customElementsShadowMode=false;function ready(callback){return new Promise(resolve=>{if(ready.dispatched){resolve(callback?callback():true)}else{document.addEventListener("GousseReady",()=>resolve(callback?callback():true))}})}ready.dispatched=false;ready.promises=[];document.addEventListener("DOMContentLoaded",()=>{Promise.all(ready.promises).then(()=>{ready.dispatched=true;dispatch("GousseReady")})});function App(rootNode,spec){return ready(()=>{if(spec===undefined&&!(rootNode instanceof Node)){[spec,rootNode]=[rootNode,document.body]}else{rootNode=rootNode||document.body}attributeAnnotations.transform(rootNode);window.emittedValues={};emitter.context(window.emittedValues,rootNode);if(typeof spec==="function"){dom.append(rootNode,spec(rootNode))}else if(Array.isArray(spec)||spec instanceof Node||spec instanceof Promise){dom.append(rootNode,spec)}else if(spec){on(spec)}dispatch("AppReady")})}ready(()=>{const appNode=document.querySelector(".app-root");if(appNode){App(appNode)}if(component.customElementsAvailable){document.querySelectorAll("template[data-component]").forEach(node=>{let shadow=node.hasAttribute("data-shadow")?node.getAttribute("data-shadow"):undefined;component(node.getAttribute("data-component"),(attrs,children)=>{return template(node,attrs,...children)},shadow==="false"?false:shadow==="true"?true:shadow)})}document.head.appendChild(h("style",{type:"text/css"},`\n        .gousse-hide { display: none; }\n        .gousse-connect { display: inline-block; }\n    `))});let gousse={on:on,dispatch:dispatch,emitter:emitter,dom:dom,h:h,connect:connect,template:template,ComponentElement:ComponentElement,component:component,defineComponentElement:defineComponentElement,ready:ready,App:App,attributeAnnotations:attributeAnnotations};gousse.globallyImported=false;gousse.excludedGlobalImports=["importGlobals","globallyImported","excludedGlobalImports"];gousse.importGlobals=(onlyIfAlreadyImported=>{if(onlyIfAlreadyImported&&!gousse.globallyImported){return}gousse.globallyImported=true;Object.entries(gousse).forEach(([key,value])=>{if(gousse.excludedGlobalImports.indexOf(key)===-1&&key.substr(0,1)!=="_"){window[key]=value}})});return gousse});